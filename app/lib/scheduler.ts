// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  GENERATE SCHEDULE â€” v12.0 (PREVIEW + RANDOM SEED)
//  
//  â— Ù‡Ø°Ø§ Ø§Ù„Ù…Ù„Ù ÙŠØªØ¨Ø¹ Ø§Ù„ØªØ¹Ù„ÙŠÙ…Ø§Øª Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© ÙÙ‚Ø· - Ù„Ø§ Ù…Ù†Ø·Ù‚ Ù‚Ø¯ÙŠÙ…
//  
//  ğŸ“Œ Ø§Ù„ØªØºØ·ÙŠØ© Ù…Ù† Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ÙÙ‚Ø· (Ø¨Ø¯ÙˆÙ† defaults):
//     - Morning Coverage = Ø¨Ø§Ù„Ø¶Ø¨Ø· Ø§Ù„Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø­Ø¯Ø¯ (Ù„Ø§ Ø²ÙŠØ§Ø¯Ø©ØŒ Ù„Ø§ Ù†Ù‚ØµØ§Ù†)
//     - Evening Coverage = Ø¨Ø§Ù„Ø¶Ø¨Ø· Ø§Ù„Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø­Ø¯Ø¯ (Ù„Ø§ Ø²ÙŠØ§Ø¯Ø©ØŒ Ù„Ø§ Ù†Ù‚ØµØ§Ù†)
//  
//  ğŸ“Œ Ù†Ø¸Ø§Ù… Ø§Ù„ØªÙˆØ²ÙŠØ¹ Ø§Ù„ÙØ±Ø¯ÙŠ (2+2):
//     - ÙƒÙ„ Ù…ÙˆØ¸ÙØ© ØªÙØ­Ø¯Ø¯ Ø£Ø³Ø§Ø¨ÙŠØ¹Ù‡Ø§ Ø¨Ø´ÙƒÙ„ Ù…Ø³ØªÙ‚Ù„ ÙˆØ¹Ø´ÙˆØ§Ø¦ÙŠ
//     - ÙƒÙ„ Ù…ÙˆØ¸ÙØ© = 2 Ø£Ø³Ø§Ø¨ÙŠØ¹ ØµØ¨Ø§Ø­ + 2 Ø£Ø³Ø§Ø¨ÙŠØ¹ Ù…Ø³Ø§Ø¡
//     - Ø§Ù„Ø§Ø®ØªÙŠØ§Ø± Ø¹Ø´ÙˆØ§Ø¦ÙŠ Ù„ÙƒÙ„ Ù…ÙˆØ¸ÙØ© Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… seed
//     - Ø§Ù„Ø´ÙØª Ø«Ø§Ø¨Øª Ø·ÙˆØ§Ù„ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹
//     - Ø§Ù„ØªØºØ·ÙŠØ© Ø§Ù„ÙŠÙˆÙ…ÙŠØ© ØªÙØ·Ø¨Ù‚ Ø¨Ø¹Ø¯ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø´ÙØªØ§Øª
//  
//  ğŸ“Œ Ù‚ÙˆØ§Ø¹Ø¯ Ø§Ù„Ø¥Ø¬Ø§Ø²Ø§Øª:
//     - Ø§Ù„Ø¬Ù…Ø¹Ø©: OFF Ù„Ù„Ø¬Ù…ÙŠØ¹
//     - Ù…Ø±ÙˆØ© (Marwa Alrehaili): Ø§Ù„Ø³Ø¨Øª OFF Ø¯Ø§Ø¦Ù…Ø§Ù‹
//     - ÙƒÙ„ Ù…ÙˆØ¸ÙØ©: OFF ÙˆØ§Ø­Ø¯ ÙÙ‚Ø· Ø£Ø³Ø¨ÙˆØ¹ÙŠØ§Ù‹
//     - Ø­Ø¯ Ø£Ù‚ØµÙ‰ 2 OFF ÙÙŠ Ø§Ù„ÙŠÙˆÙ… (Ø¹Ø¯Ø§ Ø§Ù„Ø¬Ù…Ø¹Ø©)
//     - Ù„Ø§ OFF Ø¥Ø¶Ø§ÙÙŠ Ø£Ø¨Ø¯Ø§Ù‹
//     - Ø·Ù„Ø¨Ø§Øª OFF/V Ø§Ù„Ù…Ø³Ø¨Ù‚Ø© ØªÙØ­ØªØ±Ù…
//  
//  ğŸ“Œ Between Shift:
//     - Ø¥Ø°Ø§ ON: Ù„Ù„Ù…ÙˆØ¸ÙØ© Ø§Ù„Ù…Ø­Ø¯Ø¯Ø© ÙÙ‚Ø·
//     - Ø¥Ø°Ø§ OFF: Ù„Ø§ ÙŠØ³ØªØ®Ø¯Ù… Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹
//  
//  ğŸ“Œ Ø§Ù„Ø´ÙØªØ§Øª Ø§Ù„Ù…Ø³Ù…ÙˆØ­Ø© ÙÙ‚Ø·:
//     ØµØ¨Ø§Ø­: MA1, MA2, M2, PT4
//     Ù…Ø³Ø§Ø¡: EA1, E5, E2, MA4, PT5
//     Ù„ÙŠÙ„: MA3
//     Ø¥Ø¬Ø§Ø²Ø©: O, V
//  
//  ğŸ“Œ ÙˆØ¶Ø¹ Preview:
//     - preview=true: ÙŠÙˆÙ„Ù‘Ø¯ Ø¬Ø¯ÙˆÙ„ Ø¨Ø¯ÙˆÙ† Ø­ÙØ¸
//     - seed Ø¹Ø´ÙˆØ§Ø¦ÙŠ: ÙƒÙ„ Ø¶ØºØ·Ø© "ØªÙˆÙ„ÙŠØ¯" ØªØ¹Ø·ÙŠ Ù†ØªÙŠØ¬Ø© Ù…Ø®ØªÙ„ÙØ©
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

import {
  startOfMonth,
  endOfMonth,
  eachDayOfInterval,
  format,
  getDay
} from "date-fns";

import supabaseServer from "@/app/lib/supabaseServer";

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CONSTANTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const OFF = "O";
const VAC = "V";
const BETWEEN = "B";

// Ø§Ù„Ø´ÙØªØ§Øª Ø§Ù„Ù…Ø³Ù…ÙˆØ­Ø© ÙÙ‚Ø·
const MORNING_SHIFTS: Record<string, string> = {
  FullTime: "MA1",
  PartTime: "PT4",
  Trainee: "M2"
};

const EVENING_SHIFTS: Record<string, string> = {
  FullTime: "EA1",
  PartTime: "PT5",
  Trainee: "E2"
};

const MARWA_NAME = "Marwa Alrehaili"; // Ø§Ø³Ù… Ù…Ø±ÙˆØ© Ù„Ù„Ø¨Ø­Ø«
const MAX_OFF_PER_DAY = 2;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SEEDED RANDOM - Ù„ØªÙˆÙ„ÙŠØ¯ Ø¬Ø¯Ø§ÙˆÙ„ Ù…Ø®ØªÙ„ÙØ© Ù…Ø¹ ÙƒÙ„ seed
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function seededRandom(seed: number): () => number {
  return function() {
    seed = (seed * 1103515245 + 12345) & 0x7fffffff;
    return seed / 0x7fffffff;
  };
}

function shuffleWithSeed<T>(arr: T[], seed: number): T[] {
  const result = [...arr];
  const random = seededRandom(seed);
  for (let i = result.length - 1; i > 0; i--) {
    const j = Math.floor(random() * (i + 1));
    [result[i], result[j]] = [result[j], result[i]];
  }
  return result;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TYPES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
type ShiftType = "Morning" | "Evening";

interface Employee {
  id: number | string;
  name: string;
  employment_type?: string;
}

interface Settings {
  coverageMorning: number;
  coverageEvening: number;
  useBetweenShift: boolean;
  betweenShiftEmployeeId: string | null;
}

interface DayAssignment {
  month_id: string;
  employee_id: string;
  date: string;
  symbol: string;
  code: string;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// HELPER FUNCTIONS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// Ø­Ø³Ø§Ø¨ Ø±Ù‚Ù… Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ (Ø§Ù„Ø³Ø¨Øª = Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹)
function getWeekNumber(date: Date, monthStart: Date): number {
  const startDay = monthStart.getDay();
  const dayOfMonth = date.getDate();
  // Ø­Ø³Ø§Ø¨ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ø³Ø¨Øª ÙƒØ¨Ø¯Ø§ÙŠØ©
  const adjustedDay = dayOfMonth + ((startDay + 1) % 7);
  return Math.ceil(adjustedDay / 7);
}

// Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø±Ù…Ø² Ø§Ù„Ø´ÙØª Ø­Ø³Ø¨ Ù†ÙˆØ¹ Ø§Ù„Ù…ÙˆØ¸ÙØ©
function getShiftSymbol(emp: Employee, shiftType: ShiftType): string {
  const empType = emp.employment_type || "FullTime";
  if (shiftType === "Morning") {
    return MORNING_SHIFTS[empType] || MORNING_SHIFTS.FullTime;
  }
  return EVENING_SHIFTS[empType] || EVENING_SHIFTS.FullTime;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MAIN FUNCTION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
export async function generateSchedule({
  year,
  month,
  preview = false,
  seed
}: {
  year: number;
  month: number;
  preview?: boolean;  // true = Ù„Ø§ ÙŠØ­ÙØ¸ ÙÙŠ DB
  seed?: number;      // seed Ø¹Ø´ÙˆØ§Ø¦ÙŠ Ù„ØªÙˆÙ„ÙŠØ¯ Ø¬Ø¯Ø§ÙˆÙ„ Ù…Ø®ØªÙ„ÙØ©
}) {
  const sb = supabaseServer();
  
  // Ø¥Ø°Ø§ Ù„Ù… ÙŠØªÙ… ØªÙ…Ø±ÙŠØ± seedØŒ Ù†Ø³ØªØ®Ø¯Ù… ÙˆÙ‚Øª Ø¹Ø´ÙˆØ§Ø¦ÙŠ
  const actualSeed = seed ?? Date.now();
  
  console.log(`\n${'â•'.repeat(60)}`);
  console.log(`[SCHEDULER v12] Ø¥Ù†Ø´Ø§Ø¡ Ø¬Ø¯ÙˆÙ„ ${year}-${month}`);
  console.log(`[MODE] ${preview ? 'PREVIEW (Ø¨Ø¯ÙˆÙ† Ø­ÙØ¸)' : 'SAVE (Ø­ÙØ¸ ÙÙŠ DB)'}`);
  console.log(`[SEED] ${actualSeed}`);
  console.log(`${'â•'.repeat(60)}\n`);

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // Ø§Ù„Ø®Ø·ÙˆØ© 1: ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  
  // Ø¥Ù†Ø´Ø§Ø¡/ØªØ­Ø¯ÙŠØ« Ø³Ø¬Ù„ Ø§Ù„Ø´Ù‡Ø±
  const { data: monthRow, error: monthErr } = await sb
    .from("months")
    .upsert({ year, month }, { onConflict: "year,month" })
    .select("*")
    .single();
  
  if (monthErr || !monthRow) {
    throw new Error(monthErr?.message || "ÙØ´Ù„ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø³Ø¬Ù„ Ø§Ù„Ø´Ù‡Ø±");
  }

  // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…ÙˆØ¸ÙØ§Øª
  const { data: empData } = await sb.from("employees").select("*").order("name");
  const allEmployees: Employee[] = (empData || []) as Employee[];
  console.log(`[1] Ø¹Ø¯Ø¯ Ø§Ù„Ù…ÙˆØ¸ÙØ§Øª: ${allEmployees.length}`);

  // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª (Ø§Ù„Ù…ØµØ¯Ø± Ø§Ù„ÙˆØ­ÙŠØ¯ Ù„Ù„Ø­Ù‚ÙŠÙ‚Ø©)
  const { data: settingsData } = await sb.from("settings").select("key, value");
  const settingsMap: Record<string, string> = {};
  for (const s of settingsData || []) {
    if (s.key) settingsMap[s.key] = s.value ?? "";
  }
  
  const settings: Settings = {
    coverageMorning: Number(settingsMap['coverageMorning']) || 0,
    coverageEvening: Number(settingsMap['coverageEvening']) || 0,
    useBetweenShift: settingsMap['useBetweenShift'] === 'true',
    betweenShiftEmployeeId: settingsMap['betweenShiftEmployeeId'] || null
  };
  
  console.log(`[1] Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª:`);
  console.log(`    - ØªØºØ·ÙŠØ© Ø§Ù„ØµØ¨Ø§Ø­: ${settings.coverageMorning}`);
  console.log(`    - ØªØºØ·ÙŠØ© Ø§Ù„Ù…Ø³Ø§Ø¡: ${settings.coverageEvening}`);
  console.log(`    - Between Shift: ${settings.useBetweenShift ? 'ON' : 'OFF'}`);

  // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
  if (settings.coverageMorning === 0 || settings.coverageEvening === 0) {
    throw new Error("ÙŠØ¬Ø¨ ØªØ­Ø¯ÙŠØ¯ Ù‚ÙŠÙ… Ø§Ù„ØªØºØ·ÙŠØ© ÙÙŠ ØµÙØ­Ø© Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª");
  }

  // ÙØµÙ„ Ù…ÙˆØ¸ÙØ© Between Shift
  let betweenEmployee: Employee | null = null;
  let regularEmployees: Employee[] = allEmployees;
  
  if (settings.useBetweenShift && settings.betweenShiftEmployeeId) {
    betweenEmployee = allEmployees.find(e => String(e.id) === settings.betweenShiftEmployeeId) || null;
    if (betweenEmployee) {
      regularEmployees = allEmployees.filter(e => String(e.id) !== settings.betweenShiftEmployeeId);
      console.log(`    - Ù…ÙˆØ¸ÙØ© Between: ${betweenEmployee.name}`);
    }
  }

  // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥Ø¬Ø§Ø²Ø§Øª ÙˆØ§Ù„Ø·Ù„Ø¨Ø§Øª
  const { data: vacationData } = await sb.from("requests").select("*").eq("type", "Vacation");
  const { data: offRequestData } = await sb.from("requests").select("*").eq("type", "OffRequest");
  
  const vacationSet = new Set<string>();
  for (const v of vacationData || []) {
    vacationSet.add(`${v.employee_id}_${format(new Date(v.date), "yyyy-MM-dd")}`);
  }
  
  const offRequestSet = new Set<string>();
  for (const o of offRequestData || []) {
    offRequestSet.add(`${o.employee_id}_${format(new Date(o.date), "yyyy-MM-dd")}`);
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // Ø§Ù„Ø®Ø·ÙˆØ© 2: ØªØ­Ø¶ÙŠØ± Ø§Ù„Ø£ÙŠØ§Ù… ÙˆØ§Ù„Ø£Ø³Ø§Ø¨ÙŠØ¹
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  
  const monthStart = startOfMonth(new Date(year, month - 1, 1));
  const monthEnd = endOfMonth(monthStart);
  const allDays = eachDayOfInterval({ start: monthStart, end: monthEnd });
  
  // ØªØ¬Ù…ÙŠØ¹ Ø§Ù„Ø£ÙŠØ§Ù… Ø­Ø³Ø¨ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹
  const weekDaysMap = new Map<number, Date[]>();
  for (const day of allDays) {
    const weekNum = getWeekNumber(day, monthStart);
    if (!weekDaysMap.has(weekNum)) weekDaysMap.set(weekNum, []);
    weekDaysMap.get(weekNum)!.push(day);
  }
  
  const weeks = [...weekDaysMap.keys()].sort((a, b) => a - b);
  console.log(`[2] Ø¹Ø¯Ø¯ Ø§Ù„Ø£ÙŠØ§Ù…: ${allDays.length}, Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø§Ø¨ÙŠØ¹: ${weeks.length}`);

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // Ø§Ù„Ø®Ø·ÙˆØ© 3: ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø´ÙØªØ§Øª Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ÙŠØ© (ØªÙ†Ø§ÙˆØ¨ 2+2)
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  
  console.log(`\n[3] ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø´ÙØªØ§Øª Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ÙŠØ©...`);
  
  // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ù…Ø±ÙˆØ© Ø¨Ø§Ù„Ø§Ø³Ù…
  const marwaEmployee = allEmployees.find(e => 
    e.name.toLowerCase().includes('marwa') || 
    e.name.includes('Ù…Ø±ÙˆØ©')
  );
  const marwaId = marwaEmployee ? String(marwaEmployee.id) : null;
  if (marwaEmployee) {
    console.log(`    - Ù…Ø±ÙˆØ©: ${marwaEmployee.name} (ID: ${marwaId})`);
  }
  
  // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Tooq Almaliki (Ù…Ø³Ø§Ø¦ÙŠØ© Ø¯Ø§Ø¦Ù…Ø§Ù‹) - Ø¨Ø§Ù„Ù€ ID Ø£Ùˆ Ø§Ù„Ø§Ø³Ù…
  const TOOQ_ID = "3979";
  const tooqEmployee = allEmployees.find(e => 
    String(e.id) === TOOQ_ID || 
    e.name.toLowerCase().includes('tooq')
  );
  const actualTooqId = tooqEmployee ? String(tooqEmployee.id) : null;
  if (tooqEmployee) {
    console.log(`    - Tooq Almaliki: ${tooqEmployee.name} (ID: ${actualTooqId}) - Ù…Ø³Ø§Ø¦ÙŠØ© Ø¯Ø§Ø¦Ù…Ø§Ù‹`);
  } else {
    console.log(`    - âš ï¸ Tooq Almaliki ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©!`);
  }
  
  // Ø§Ù„Ù…ÙˆØ¸ÙØ§Øª Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ§Øª ÙÙŠ Ø§Ù„ØªÙ†Ø§ÙˆØ¨ (Ø¨Ø¯ÙˆÙ† Tooq)
  const rotatingEmployees = regularEmployees.filter(e => 
    String(e.id) !== TOOQ_ID && 
    !e.name.toLowerCase().includes('tooq')
  );
  
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // Ù†Ø¸Ø§Ù… Ø§Ù„ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠ Ø¨Ø§Ù„Ø£ÙˆÙ„ÙˆÙŠØ©
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // - ÙÙŠ ÙƒÙ„ Ø£Ø³Ø¨ÙˆØ¹ØŒ Ù†Ø­Ø³Ø¨ Ø¹Ø¯Ø¯ Ø£Ø³Ø§Ø¨ÙŠØ¹ Morning Ùˆ Evening Ø§Ù„Ø³Ø§Ø¨Ù‚Ø© Ù„ÙƒÙ„ Ù…ÙˆØ¸ÙØ©
  // - Ø£ÙˆÙ„ÙˆÙŠØ© Ø§Ù„ØµØ¨Ø§Ø­: Ù„Ù„Ù…ÙˆØ¸ÙØ§Øª Ø§Ù„Ù„ÙŠ Ø¹Ù†Ø¯Ù‡Ù† Evening > Morning
  // - Ø£ÙˆÙ„ÙˆÙŠØ© Ø§Ù„Ù…Ø³Ø§Ø¡: Ù„Ù„Ù…ÙˆØ¸ÙØ§Øª Ø§Ù„Ù„ÙŠ Ø¹Ù†Ø¯Ù‡Ù† Morning > Evening
  // - Ù‡Ø°Ø§ ÙŠØ¶Ù…Ù† ØªÙˆØ²ÙŠØ¹ Ù…ØªÙˆØ§Ø²Ù† (2 ØµØ¨Ø§Ø­ + 2 Ù…Ø³Ø§Ø¡) ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  
  console.log(`    - Ø¹Ø¯Ø¯ Ø§Ù„Ù…ÙˆØ¸ÙØ§Øª Ø§Ù„Ø¹Ø§Ø¯ÙŠØ©: ${regularEmployees.length}`);
  console.log(`    - Ø¹Ø¯Ø¯ Ø§Ù„Ù…ÙˆØ¸ÙØ§Øª ÙÙŠ Ø§Ù„ØªÙ†Ø§ÙˆØ¨: ${rotatingEmployees.length}`);
  console.log(`    - Ø§Ù„ØªØºØ·ÙŠØ© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©: ØµØ¨Ø§Ø­=${settings.coverageMorning}, Ù…Ø³Ø§Ø¡=${settings.coverageEvening}`);
  if (betweenEmployee) {
    console.log(`    - Ù…ÙˆØ¸ÙØ© Between: ${betweenEmployee.name} (Ù…Ø³ØªØ¨Ø¹Ø¯Ø© Ù…Ù† Ø§Ù„ØªÙˆØ²ÙŠØ¹)`);
  }
  
  // Ø­Ø³Ø§Ø¨ Ø§Ù„ØªØºØ·ÙŠØ© Ø§Ù„Ù…Ø³Ø§Ø¦ÙŠØ© Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ© (Ø¨Ø¹Ø¯ Ø­Ø¬Ø² Tooq)
  const eveningCoverageForRotation = tooqEmployee 
    ? settings.coverageEvening - 1  // Tooq Ù…Ø­Ø¬ÙˆØ²Ø© Ù…Ø³Ø¨Ù‚Ø§Ù‹
    : settings.coverageEvening;
  
  console.log(`    - Ø§Ù„ØªØºØ·ÙŠØ© Ø§Ù„Ù…Ø³Ø§Ø¦ÙŠØ© Ù„Ù„ØªÙ†Ø§ÙˆØ¨: ${eveningCoverageForRotation} (Tooq Ù…Ø­Ø¬ÙˆØ²Ø©: ${tooqEmployee ? 'Ù†Ø¹Ù…' : 'Ù„Ø§'})`);
  
  // ØªØªØ¨Ø¹ Ø¹Ø¯Ø¯ Ø£Ø³Ø§Ø¨ÙŠØ¹ Ø§Ù„ØµØ¨Ø§Ø­ ÙˆØ§Ù„Ù…Ø³Ø§Ø¡ Ù„ÙƒÙ„ Ù…ÙˆØ¸ÙØ© (ÙÙ‚Ø· Ù„Ù„Ù…ÙˆØ¸ÙØ§Øª ÙÙŠ Ø§Ù„ØªÙ†Ø§ÙˆØ¨)
  const empShiftHistory = new Map<string, { morning: number; evening: number }>();
  for (const emp of rotatingEmployees) {
    empShiftHistory.set(String(emp.id), { morning: 0, evening: 0 });
  }
  
  // Ø¨Ù†Ø§Ø¡ Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø´ÙØªØ§Øª Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ÙŠØ©
  const weeklyShifts = new Map<number, Map<string, ShiftType>>();
  
  // ØªØªØ¨Ø¹ Ø§Ù„Ø´ÙØª Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ÙŠ Ù„ÙƒÙ„ Ù…ÙˆØ¸ÙØ© (Ù„Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… ÙÙŠ Ø¨Ù†Ø§Ø¡ Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„ÙŠÙˆÙ…ÙŠ)
  const empWeeklyShift = new Map<string, Map<number, ShiftType>>();
  for (const emp of regularEmployees) {
    empWeeklyShift.set(String(emp.id), new Map());
  }
  
  // Tooq Ø¯Ø§Ø¦Ù…Ø§Ù‹ Ù…Ø³Ø§Ø¦ÙŠØ© ÙÙŠ ÙƒÙ„ Ø§Ù„Ø£Ø³Ø§Ø¨ÙŠØ¹
  if (tooqEmployee) {
    const tooqId = String(tooqEmployee.id);
    // Ø¥Ø¶Ø§ÙØ© Tooq Ø¥Ù„Ù‰ empWeeklyShift Ø¥Ø°Ø§ Ù„Ù… ØªÙƒÙ† Ù…ÙˆØ¬ÙˆØ¯Ø©
    if (!empWeeklyShift.has(tooqId)) {
      empWeeklyShift.set(tooqId, new Map());
    }
    for (const weekNum of weeks) {
      empWeeklyShift.get(tooqId)!.set(weekNum, "Evening");
    }
  }
  
  for (const weekNum of weeks) {
    const shiftMap = new Map<string, ShiftType>();
    weeklyShifts.set(weekNum, shiftMap);
    
    // Tooq Ø¯Ø§Ø¦Ù…Ø§Ù‹ Ù…Ø³Ø§Ø¦ÙŠØ©
    if (tooqEmployee) {
      shiftMap.set(String(tooqEmployee.id), "Evening");
    }
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // Ø­Ø³Ø§Ø¨ Ø§Ù„Ø£ÙˆÙ„ÙˆÙŠØ© Ù„ÙƒÙ„ Ù…ÙˆØ¸ÙØ© (ÙÙ‚Ø· Ù„Ù„Ù…ÙˆØ¸ÙØ§Øª ÙÙŠ Ø§Ù„ØªÙ†Ø§ÙˆØ¨)
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // priority > 0 â†’ ØªØ­ØªØ§Ø¬ ØµØ¨Ø§Ø­ (Ø¹Ù†Ø¯Ù‡Ø§ Ù…Ø³Ø§Ø¡ Ø£ÙƒØ«Ø±)
    // priority < 0 â†’ ØªØ­ØªØ§Ø¬ Ù…Ø³Ø§Ø¡ (Ø¹Ù†Ø¯Ù‡Ø§ ØµØ¨Ø§Ø­ Ø£ÙƒØ«Ø±)
    // priority = 0 â†’ Ù…ØªÙˆØ§Ø²Ù†Ø©
    
    interface EmpPriority {
      emp: Employee;
      priority: number; // evening - morning
      morningCount: number;
      eveningCount: number;
    }
    
    const priorities: EmpPriority[] = [];
    
    for (const emp of rotatingEmployees) {
      const empId = String(emp.id);
      const history = empShiftHistory.get(empId)!;
      priorities.push({
        emp,
        priority: history.evening - history.morning,
        morningCount: history.morning,
        eveningCount: history.evening
      });
    }
    
    // Ø®Ù„Ø· Ø¹Ø´ÙˆØ§Ø¦ÙŠ Ø£ÙˆÙ„Ø§Ù‹ (Ù„ÙƒØ³Ø± Ø§Ù„ØªØ¹Ø§Ø¯Ù„)
    const shuffledPriorities = shuffleWithSeed(priorities, actualSeed + weekNum * 1000);
    
    // ØªØ±ØªÙŠØ¨ Ø­Ø³Ø¨ Ø§Ù„Ø£ÙˆÙ„ÙˆÙŠØ©
    // Ù„Ù„ØµØ¨Ø§Ø­: Ù†Ø±ÙŠØ¯ Ø§Ù„Ù„ÙŠ Ø¹Ù†Ø¯Ù‡Ù† evening > morning (priority Ø¹Ø§Ù„ÙŠ)
    // Ù„Ù„Ù…Ø³Ø§Ø¡: Ù†Ø±ÙŠØ¯ Ø§Ù„Ù„ÙŠ Ø¹Ù†Ø¯Ù‡Ù† morning > evening (priority Ù…Ù†Ø®ÙØ¶)
    
    // Ù…Ø±Ø´Ø­Ø§Øª Ø§Ù„ØµØ¨Ø§Ø­: ØªØ±ØªÙŠØ¨ ØªÙ†Ø§Ø²Ù„ÙŠ Ø­Ø³Ø¨ priority (Tooq Ù…Ø³ØªØ¨Ø¹Ø¯Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹)
    const morningCandidates = [...shuffledPriorities].sort((a, b) => b.priority - a.priority);
    
    // Ù…Ø±Ø´Ø­Ø§Øª Ø§Ù„Ù…Ø³Ø§Ø¡: ØªØ±ØªÙŠØ¨ ØªØµØ§Ø¹Ø¯ÙŠ Ø­Ø³Ø¨ priority (Tooq Ù…Ø³ØªØ¨Ø¹Ø¯Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹)
    const eveningCandidates = [...shuffledPriorities].sort((a, b) => a.priority - b.priority);
    
    // Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…ÙˆØ¸ÙØ§Øª
    const selectedMorningIds = new Set<string>();
    const selectedEveningIds = new Set<string>();
    
    // Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ØµØ¨Ø§Ø­ Ø£ÙˆÙ„Ø§Ù‹
    for (const p of morningCandidates) {
      if (selectedMorningIds.size >= settings.coverageMorning) break;
      selectedMorningIds.add(String(p.emp.id));
    }
    
    // Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ø³Ø§Ø¡ (Ù…Ù† ØºÙŠØ± Ø§Ù„Ù…Ø®ØªØ§Ø±Ø§Øª Ù„Ù„ØµØ¨Ø§Ø­) - Ø§Ù„ØªØºØ·ÙŠØ© Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ© Ø¨Ø¹Ø¯ Tooq
    for (const p of eveningCandidates) {
      if (selectedEveningIds.size >= eveningCoverageForRotation) break;
      const empId = String(p.emp.id);
      if (!selectedMorningIds.has(empId)) {
        selectedEveningIds.add(empId);
      }
    }
    
    // Ø¥Ø°Ø§ Ù„Ù… Ù†Ø­ØµÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø¹Ø¯Ø¯ Ø§Ù„ÙƒØ§ÙÙŠ Ù„Ù„Ù…Ø³Ø§Ø¡ØŒ Ù†Ø£Ø®Ø° Ù…Ù† Ø§Ù„Ø¨Ø§Ù‚ÙŠ
    if (selectedEveningIds.size < eveningCoverageForRotation) {
      for (const p of morningCandidates) {
        if (selectedEveningIds.size >= eveningCoverageForRotation) break;
        const empId = String(p.emp.id);
        if (!selectedMorningIds.has(empId) && !selectedEveningIds.has(empId)) {
          selectedEveningIds.add(empId);
        }
      }
    }
    
    // ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø´ÙØªØ§Øª ÙˆØªØ­Ø¯ÙŠØ« Ø§Ù„ØªØ§Ø±ÙŠØ® (ÙÙ‚Ø· Ù„Ù„Ù…ÙˆØ¸ÙØ§Øª ÙÙŠ Ø§Ù„ØªÙ†Ø§ÙˆØ¨)
    for (const emp of rotatingEmployees) {
      const empId = String(emp.id);
      let shift: ShiftType;
      
      if (selectedMorningIds.has(empId)) {
        shift = "Morning";
        empShiftHistory.get(empId)!.morning++;
      } else if (selectedEveningIds.has(empId)) {
        shift = "Evening";
        empShiftHistory.get(empId)!.evening++;
      } else {
        // Ù…ÙˆØ¸ÙØ© Ø²Ø§Ø¦Ø¯Ø© - Ù†Ø¹Ø·ÙŠÙ‡Ø§ Ø§Ù„Ø´ÙØª Ø§Ù„Ø£Ù‚Ù„ Ù„Ø¯ÙŠÙ‡Ø§
        const history = empShiftHistory.get(empId)!;
        if (history.morning <= history.evening) {
          shift = "Morning";
          history.morning++;
        } else {
          shift = "Evening";
          history.evening++;
        }
      }
      
      shiftMap.set(empId, shift);
      empWeeklyShift.get(empId)!.set(weekNum, shift);
    }
    
    // Ø­Ø³Ø§Ø¨ Ø§Ù„ØªØºØ·ÙŠØ© Ø§Ù„ÙØ¹Ù„ÙŠØ© (Ù…Ø¹ Tooq)
    const actualEvening = selectedEveningIds.size + (tooqEmployee ? 1 : 0);
    console.log(`    - Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ ${weekNum}: ØµØ¨Ø§Ø­=${selectedMorningIds.size}, Ù…Ø³Ø§Ø¡=${actualEvening} (Tooq+${selectedEveningIds.size})`);
  }
  
  // Ø·Ø¨Ø§Ø¹Ø© Ù…Ù„Ø®Øµ Ø§Ù„ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ
  console.log(`\n    ğŸ“Š Ù…Ù„Ø®Øµ Ø§Ù„ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ:`);
  for (const emp of regularEmployees) {
    const empId = String(emp.id);
    const weekShifts = empWeeklyShift.get(empId);
    if (!weekShifts) continue; // ØªØ®Ø·ÙŠ Ø¥Ø°Ø§ Ù„Ù… ØªÙƒÙ† Ù…ÙˆØ¬ÙˆØ¯Ø©
    
    const pattern = weeks.map(w => weekShifts.get(w) === "Morning" ? "M" : "E").join("-");
    
    // Ø§Ù„ØªØ­Ù‚Ù‚ Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Tooq (Ø¨Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ ID)
    const isTooq = empId === TOOQ_ID || emp.name.toLowerCase().includes('tooq');
    if (isTooq) {
      console.log(`    - ${emp.name}: Ù…Ø³Ø§Ø¦ÙŠØ© Ø¯Ø§Ø¦Ù…Ø§Ù‹ [${pattern}] â­`);
    } else {
      const history = empShiftHistory.get(empId);
      if (history) {
        console.log(`    - ${emp.name}: ØµØ¨Ø§Ø­=${history.morning}, Ù…Ø³Ø§Ø¡=${history.evening} [${pattern}]`);
      } else {
        console.log(`    - ${emp.name}: [${pattern}]`);
      }
    }
  }
  
  // Ø·Ø¨Ø§Ø¹Ø© Tooq Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù…ÙˆØ¬ÙˆØ¯Ø©
  if (tooqEmployee) {
    const tooqId = String(tooqEmployee.id);
    const weekShifts = empWeeklyShift.get(tooqId);
    if (weekShifts) {
      const pattern = weeks.map(w => weekShifts.get(w) === "Morning" ? "M" : "E").join("-");
      console.log(`    - ${tooqEmployee.name}: Ù…Ø³Ø§Ø¦ÙŠØ© Ø¯Ø§Ø¦Ù…Ø§Ù‹ [${pattern}] â­`);
    }
  }
  
  // Ù„Ù„ØªÙˆØ§ÙÙ‚ Ù…Ø¹ Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ù‚Ø¯ÙŠÙ…
  const empMorningWeeks = new Map<string, number[]>();
  for (const emp of regularEmployees) {
    const empId = String(emp.id);
    const weekShifts = empWeeklyShift.get(empId);
    if (!weekShifts) continue;
    const morningWeeks = weeks.filter(w => weekShifts.get(w) === "Morning");
    empMorningWeeks.set(empId, morningWeeks);
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // Ø§Ù„Ø®Ø·ÙˆØ© 4: ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø¥Ø¬Ø§Ø²Ø§Øª Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ÙŠØ© (Ø¹Ø´ÙˆØ§Ø¦ÙŠ)
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // - Ø§Ù„Ø¬Ù…Ø¹Ø©: OFF Ù„Ù„Ø¬Ù…ÙŠØ¹ (ÙŠØªÙ… ÙÙŠ Ø§Ù„Ø®Ø·ÙˆØ© 5)
  // - Ù…Ø±ÙˆØ©: Ø§Ù„Ø³Ø¨Øª OFF Ø¯Ø§Ø¦Ù…Ø§Ù‹
  // - Ø¨Ø§Ù‚ÙŠ Ø§Ù„Ù…ÙˆØ¸ÙØ§Øª: OFF Ø¹Ø´ÙˆØ§Ø¦ÙŠ Ù…Ù† Ø§Ù„Ø£Ø­Ø¯-Ø§Ù„Ø®Ù…ÙŠØ³ ÙÙ‚Ø·
  // - Ù„Ø§ ÙŠÙØ³Ù…Ø­ Ø¨Ù€ OFF ÙŠÙˆÙ… Ø§Ù„Ø³Ø¨Øª Ù„ØºÙŠØ± Ù…Ø±ÙˆØ©
  // - Ø­Ø¯ Ø£Ù‚ØµÙ‰ 2 OFF Ù„ÙƒÙ„ ÙŠÙˆÙ…
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  
  console.log(`\n[4] ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø¥Ø¬Ø§Ø²Ø§Øª Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ÙŠØ© (Ø¹Ø´ÙˆØ§Ø¦ÙŠ)...`);
  
  // weekNum -> empId -> dateISO
  const weeklyOffDays = new Map<number, Map<string, string>>();
  
  for (const weekNum of weeks) {
    const offMap = new Map<string, string>();
    weeklyOffDays.set(weekNum, offMap);
    
    const weekDays = weekDaysMap.get(weekNum) || [];
    
    // Ø£ÙŠØ§Ù… Ø§Ù„Ø¹Ù…Ù„ (Ø¨Ø¯ÙˆÙ† Ø§Ù„Ø¬Ù…Ø¹Ø©)
    const workDays = weekDays.filter(d => getDay(d) !== 5);
    
    // Ø£ÙŠØ§Ù… OFF Ø§Ù„Ù…Ø³Ù…ÙˆØ­Ø© Ù„ØºÙŠØ± Ù…Ø±ÙˆØ© (Ø§Ù„Ø£Ø­Ø¯=0 Ø¥Ù„Ù‰ Ø§Ù„Ø®Ù…ÙŠØ³=4 ÙÙ‚Ø·ØŒ Ø¨Ø¯ÙˆÙ† Ø§Ù„Ø³Ø¨Øª=6)
    const offDaysForOthers = workDays.filter(d => {
      const dow = getDay(d);
      return dow >= 0 && dow <= 4; // Ø§Ù„Ø£Ø­Ø¯ØŒ Ø§Ù„Ø¥Ø«Ù†ÙŠÙ†ØŒ Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡ØŒ Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡ØŒ Ø§Ù„Ø®Ù…ÙŠØ³
    });
    
    if (workDays.length === 0) continue;
    
    // Ø®Ù„Ø· Ø£ÙŠØ§Ù… OFF Ø¹Ø´ÙˆØ§Ø¦ÙŠØ§Ù‹ (Ù„Ù„Ù…ÙˆØ¸ÙØ§Øª ØºÙŠØ± Ù…Ø±ÙˆØ©)
    const shuffledOffDays = shuffleWithSeed([...offDaysForOthers], actualSeed + weekNum * 500);
    
    // ØªØªØ¨Ø¹ Ø¹Ø¯Ø¯ OFF Ù„ÙƒÙ„ ÙŠÙˆÙ…
    const dayOffCount = new Map<string, number>();
    for (const d of workDays) {
      dayOffCount.set(format(d, "yyyy-MM-dd"), 0);
    }
    
    // Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…ÙˆØ¸ÙØ§Øª (Ø¹Ø§Ø¯ÙŠØ© + between) - Ù…Ø®Ù„ÙˆØ·Ø© Ø¹Ø´ÙˆØ§Ø¦ÙŠØ§Ù‹
    const allEmpsForOff = [...regularEmployees];
    if (betweenEmployee) allEmpsForOff.push(betweenEmployee);
    const shuffledEmps = shuffleWithSeed(allEmpsForOff, actualSeed + weekNum * 700);
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // Ø£ÙˆÙ„Ø§Ù‹: Ù…Ø¹Ø§Ù„Ø¬Ø© Ù…Ø±ÙˆØ© (Ø§Ù„Ø³Ø¨Øª OFF)
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    if (marwaId) {
      const marwaEmp = allEmpsForOff.find(e => String(e.id) === marwaId);
      if (marwaEmp) {
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¹Ø¯Ù… ÙˆØ¬ÙˆØ¯ Vacation
        let marwaHasVacation = false;
        for (const d of workDays) {
          const dateISO = format(d, "yyyy-MM-dd");
          if (vacationSet.has(`${marwaId}_${dateISO}`)) {
            marwaHasVacation = true;
            break;
          }
        }
        
        if (!marwaHasVacation) {
          const saturday = workDays.find(d => getDay(d) === 6);
          if (saturday) {
            const saturdayISO = format(saturday, "yyyy-MM-dd");
            const count = dayOffCount.get(saturdayISO) || 0;
            if (count < MAX_OFF_PER_DAY) {
              offMap.set(marwaId, saturdayISO);
              dayOffCount.set(saturdayISO, count + 1);
            } else {
              // Ø§Ù„Ø³Ø¨Øª Ù…Ù…ØªÙ„Ø¦ - Ø§Ø®ØªÙŠØ§Ø± Ø£Ù‚Ø±Ø¨ ÙŠÙˆÙ… Ù…ØªØ§Ø­
              for (const d of shuffledOffDays) {
                const dateISO = format(d, "yyyy-MM-dd");
                const c = dayOffCount.get(dateISO) || 0;
                if (c < MAX_OFF_PER_DAY) {
                  offMap.set(marwaId, dateISO);
                  dayOffCount.set(dateISO, c + 1);
                  break;
                }
              }
            }
          }
        }
      }
    }
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // Ø«Ø§Ù†ÙŠØ§Ù‹: Ù…Ø¹Ø§Ù„Ø¬Ø© Tooq (OFF ÙÙŠ Ø£ÙŠØ§Ù… Ø§Ù„Ù…Ø³Ø§Ø¡ ÙÙ‚Ø·)
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    if (tooqEmployee) {
      // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¹Ø¯Ù… ÙˆØ¬ÙˆØ¯ Vacation
      let tooqHasVacation = false;
      for (const d of workDays) {
        const dateISO = format(d, "yyyy-MM-dd");
        if (vacationSet.has(`${TOOQ_ID}_${dateISO}`)) {
          tooqHasVacation = true;
          break;
        }
      }
      
      if (!tooqHasVacation && !offMap.has(TOOQ_ID)) {
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø·Ù„Ø¨ OFF Ù…Ø³Ø¨Ù‚
        let tooqHasOffRequest = false;
        for (const d of workDays) {
          const dateISO = format(d, "yyyy-MM-dd");
          if (offRequestSet.has(`${TOOQ_ID}_${dateISO}`)) {
            const count = dayOffCount.get(dateISO) || 0;
            if (count < MAX_OFF_PER_DAY) {
              offMap.set(TOOQ_ID, dateISO);
              dayOffCount.set(dateISO, count + 1);
              tooqHasOffRequest = true;
              break;
            }
          }
        }
        
        // Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù‡Ù†Ø§Ùƒ Ø·Ù„Ø¨ OFFØŒ Ø§Ø®ØªÙŠØ§Ø± ÙŠÙˆÙ… Ø¹Ø´ÙˆØ§Ø¦ÙŠ Ù…Ù† Ø£ÙŠØ§Ù… Ø§Ù„Ù…Ø³Ø§Ø¡ ÙÙ‚Ø·
        if (!tooqHasOffRequest) {
          // Tooq ØªØ­ØµÙ„ Ø¹Ù„Ù‰ OFF Ù…Ù† Ø§Ù„Ø£Ø­Ø¯-Ø§Ù„Ø®Ù…ÙŠØ³ (Ø£ÙŠØ§Ù… Ø§Ù„Ù…Ø³Ø§Ø¡)
          // Ù„Ø£Ù†Ù‡Ø§ Ù…Ø³Ø§Ø¦ÙŠØ© Ø¯Ø§Ø¦Ù…Ø§Ù‹ØŒ ÙƒÙ„ Ø£ÙŠØ§Ù… Ø§Ù„Ø¹Ù…Ù„ Ù‡ÙŠ Ø£ÙŠØ§Ù… Ù…Ø³Ø§Ø¡ Ù„Ù‡Ø§
          for (const d of shuffledOffDays) {
            const dateISO = format(d, "yyyy-MM-dd");
            const count = dayOffCount.get(dateISO) || 0;
            if (count < MAX_OFF_PER_DAY) {
              offMap.set(TOOQ_ID, dateISO);
              dayOffCount.set(dateISO, count + 1);
              break;
            }
          }
        }
      }
    }
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // Ø«Ø§Ù„Ø«Ø§Ù‹: Ù…Ø¹Ø§Ù„Ø¬Ø© Ø¨Ø§Ù‚ÙŠ Ø§Ù„Ù…ÙˆØ¸ÙØ§Øª
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    for (const emp of shuffledEmps) {
      const empId = String(emp.id);
      
      // ØªØ®Ø·ÙŠ Ù…Ø±ÙˆØ© (ØªÙ… Ù…Ø¹Ø§Ù„Ø¬ØªÙ‡Ø§)
      if (empId === marwaId) continue;
      
      // ØªØ®Ø·ÙŠ Tooq (ØªÙ… Ù…Ø¹Ø§Ù„Ø¬ØªÙ‡Ø§)
      if (empId === TOOQ_ID) continue;
      
      // ØªØ®Ø·ÙŠ Ø¥Ø°Ø§ ØªÙ… ØªØ¹ÙŠÙŠÙ† OFF Ø¨Ø§Ù„ÙØ¹Ù„
      if (offMap.has(empId)) continue;
      
      // 1. Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø·Ù„Ø¨ OFF Ù…Ø³Ø¨Ù‚
      let hasOffRequest = false;
      for (const d of workDays) {
        const dateISO = format(d, "yyyy-MM-dd");
        if (offRequestSet.has(`${empId}_${dateISO}`)) {
          const count = dayOffCount.get(dateISO) || 0;
          if (count < MAX_OFF_PER_DAY) {
            offMap.set(empId, dateISO);
            dayOffCount.set(dateISO, count + 1);
            hasOffRequest = true;
            break;
          }
        }
      }
      if (hasOffRequest) continue;
      
      // 2. Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø¥Ø¬Ø§Ø²Ø© V - Ù„Ø§ ØªØ¹Ø·Ù‰ OFF Ø¥Ø¶Ø§ÙÙŠ
      let hasVacation = false;
      for (const d of workDays) {
        const dateISO = format(d, "yyyy-MM-dd");
        if (vacationSet.has(`${empId}_${dateISO}`)) {
          hasVacation = true;
          break;
        }
      }
      if (hasVacation) continue;
      
      // 3. Ø§Ø®ØªÙŠØ§Ø± ÙŠÙˆÙ… OFF Ø¹Ø´ÙˆØ§Ø¦ÙŠ Ù…Ù† Ø§Ù„Ø£Ø­Ø¯-Ø§Ù„Ø®Ù…ÙŠØ³ ÙÙ‚Ø·
      for (const d of shuffledOffDays) {
        const dateISO = format(d, "yyyy-MM-dd");
        const count = dayOffCount.get(dateISO) || 0;
        if (count < MAX_OFF_PER_DAY) {
          offMap.set(empId, dateISO);
          dayOffCount.set(dateISO, count + 1);
          break;
        }
      }
    }
    
    // Ø·Ø¨Ø§Ø¹Ø© Ù…Ù„Ø®Øµ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹
    const offCounts: Record<string, number> = {};
    for (const [day, count] of dayOffCount) {
      if (count > 0) offCounts[day] = count;
    }
    console.log(`    - Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ ${weekNum}: ${Object.entries(offCounts).map(([d, c]) => `${d}=${c}`).join(', ')}`);
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // Ø§Ù„Ø®Ø·ÙˆØ© 5: Ø¨Ù†Ø§Ø¡ Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„ÙŠÙˆÙ…ÙŠ
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  
  console.log(`\n[5] Ø¨Ù†Ø§Ø¡ Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„ÙŠÙˆÙ…ÙŠ...`);
  
  const rows: DayAssignment[] = [];
  
  for (const day of allDays) {
    const dateISO = format(day, "yyyy-MM-dd");
    const dow = getDay(day);
    const weekNum = getWeekNumber(day, monthStart);
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // Ø§Ù„Ø¬Ù…Ø¹Ø©: OFF Ù„Ù„Ø¬Ù…ÙŠØ¹
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    if (dow === 5) {
      for (const emp of allEmployees) {
        rows.push({
          month_id: monthRow.id,
          employee_id: String(emp.id),
          date: dateISO,
          symbol: OFF,
          code: OFF
        });
      }
      continue;
    }
    
    const weekOffMap = weeklyOffDays.get(weekNum) || new Map();
    const weekShiftMap = weeklyShifts.get(weekNum) || new Map();
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // Ø¨Ù†Ø§Ø¡ Ø§Ù„Ø³Ø¬Ù„Ø§Øª
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    for (const emp of allEmployees) {
      const empId = String(emp.id);
      let symbol: string;
      
      // 1. Ù…ÙˆØ¸ÙØ© Between Shift (Ø£ÙˆÙ„Ø§Ù‹ Ù‚Ø¨Ù„ Ø£ÙŠ Ø´ÙŠØ¡)
      if (betweenEmployee && empId === String(betweenEmployee.id)) {
        if (weekOffMap.get(empId) === dateISO) {
          symbol = OFF;
        } else if (vacationSet.has(`${empId}_${dateISO}`)) {
          symbol = VAC;
        } else {
          symbol = BETWEEN;
        }
      }
      // 2. Tooq Almaliki - Ù…Ø³Ø§Ø¦ÙŠØ© Ø¯Ø§Ø¦Ù…Ø§Ù‹ (Ù…Ù‚Ø§Ø±Ù†Ø© Ø¨Ø§Ù„Ø§Ø³Ù… Ø£ÙŠØ¶Ø§Ù‹)
      else if (empId === TOOQ_ID || emp.name.toLowerCase().includes('tooq')) {
        if (vacationSet.has(`${empId}_${dateISO}`)) {
          symbol = VAC;
        } else if (weekOffMap.get(empId) === dateISO) {
          symbol = OFF;
        } else {
          // Ø¯Ø§Ø¦Ù…Ø§Ù‹ Ù…Ø³Ø§Ø¦ÙŠØ©
          symbol = getShiftSymbol(emp, "Evening");
        }
      }
      // 3. Ø¥Ø¬Ø§Ø²Ø© V
      else if (vacationSet.has(`${empId}_${dateISO}`)) {
        symbol = VAC;
      }
      // 4. OFF Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ÙŠ
      else if (weekOffMap.get(empId) === dateISO) {
        symbol = OFF;
      }
      // 5. Ù…ÙˆØ¸ÙØ© Ù„Ù‡Ø§ Ø´ÙØª Ù…Ø­Ø¯Ø¯ Ù‡Ø°Ø§ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹
      else {
        const shift = weekShiftMap.get(empId);
        if (shift === "Morning") {
          symbol = getShiftSymbol(emp, "Morning");
        } else if (shift === "Evening") {
          symbol = getShiftSymbol(emp, "Evening");
        } else {
          // fallback - Ù„Ø§ ÙŠØ¬Ø¨ Ø£Ù† ÙŠØ­Ø¯Ø«
          console.warn(`[WARN] Ù…ÙˆØ¸ÙØ© Ø¨Ø¯ÙˆÙ† Ø´ÙØª: ${emp.name} ÙÙŠ ${dateISO}`);
          symbol = getShiftSymbol(emp, "Morning");
        }
      }
      
      rows.push({
        month_id: monthRow.id,
        employee_id: String(emp.id),
        date: dateISO,
        symbol,
        code: symbol
      });
    }
  }
  
  console.log(`[5] Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø³Ø¬Ù„Ø§Øª: ${rows.length}`);

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // Ø§Ù„Ø®Ø·ÙˆØ© 6: Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØªØºØ·ÙŠØ©
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  
  console.log(`\n[6] Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØªØºØ·ÙŠØ©...`);
  
  const morningSymbols = Object.values(MORNING_SHIFTS);
  const eveningSymbols = Object.values(EVENING_SHIFTS);
  
  let issues = 0;
  
  for (const day of allDays) {
    const dateISO = format(day, "yyyy-MM-dd");
    if (getDay(day) === 5) continue;
    
    const dayRows = rows.filter(r => r.date === dateISO);
    const mCount = dayRows.filter(r => morningSymbols.includes(r.symbol)).length;
    const eCount = dayRows.filter(r => eveningSymbols.includes(r.symbol)).length;
    
    if (mCount !== settings.coverageMorning) {
      console.log(`    âš ï¸ ${dateISO}: ØµØ¨Ø§Ø­=${mCount}/${settings.coverageMorning}`);
      issues++;
    }
    if (eCount !== settings.coverageEvening) {
      console.log(`    âš ï¸ ${dateISO}: Ù…Ø³Ø§Ø¡=${eCount}/${settings.coverageEvening}`);
      issues++;
    }
  }
  
  if (issues === 0) {
    console.log(`    âœ… Ø§Ù„ØªØºØ·ÙŠØ© Ù…Ø·Ø§Ø¨Ù‚Ø© Ù„Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª!`);
  } else {
    console.log(`    âš ï¸ ${issues} Ù…Ø´ÙƒÙ„Ø© ÙÙŠ Ø§Ù„ØªØºØ·ÙŠØ©`);
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // Ø§Ù„Ø®Ø·ÙˆØ© 7: Ø§Ù„Ø­ÙØ¸ ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (ÙÙ‚Ø· Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† preview)
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  
  if (!preview) {
    console.log(`\n[7] Ø§Ù„Ø­ÙØ¸ ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...`);
    
    await sb.from("assignments").delete().eq("month_id", monthRow.id);
    const { error: insertErr } = await sb.from("assignments").insert(rows);
    
    if (insertErr) throw insertErr;
    console.log(`    âœ… ØªÙ… Ø­ÙØ¸ ${rows.length} Ø³Ø¬Ù„!`);
  } else {
    console.log(`\n[7] ÙˆØ¶Ø¹ Preview - Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø­ÙØ¸ ÙÙŠ DB`);
  }

  // ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„ØµÙŠØºØ© Ù…Ù†Ø§Ø³Ø¨Ø© Ù„Ù„Ø¹Ø±Ø¶
  const assignmentsForDisplay = rows.map(r => ({
    employee_id: r.employee_id,
    date: r.date,
    symbol: r.symbol
  }));

  return {
    ok: true,
    preview,
    seed: actualSeed,
    month: {
      id: monthRow.id,
      year,
      month
    },
    employees: allEmployees.map(e => ({
      id: String(e.id),
      name: e.name,
      code: (e as any).code || null
    })),
    assignments: assignmentsForDisplay,
    debug: {
      totalEmployees: allEmployees.length,
      coverageMorning: settings.coverageMorning,
      coverageEvening: settings.coverageEvening,
      useBetweenShift: settings.useBetweenShift,
      betweenEmployee: betweenEmployee?.name || null,
      weeks: weeks.length,
      totalAssignments: rows.length,
      issues
    }
  };
}
