// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  GENERATE SCHEDULE â€” v12.0 (PREVIEW + RANDOM SEED)
//  
//  â— Ù‡Ø°Ø§ Ø§Ù„Ù…Ù„Ù ÙŠØªØ¨Ø¹ Ø§Ù„ØªØ¹Ù„ÙŠÙ…Ø§Øª Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© ÙÙ‚Ø· - Ù„Ø§ Ù…Ù†Ø·Ù‚ Ù‚Ø¯ÙŠÙ…
//  
//  ğŸ“Œ Ø§Ù„ØªØºØ·ÙŠØ© Ù…Ù† Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ÙÙ‚Ø· (Ø¨Ø¯ÙˆÙ† defaults):
//     - Morning Coverage = Ø¨Ø§Ù„Ø¶Ø¨Ø· Ø§Ù„Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø­Ø¯Ø¯ (Ù„Ø§ Ø²ÙŠØ§Ø¯Ø©ØŒ Ù„Ø§ Ù†Ù‚ØµØ§Ù†)
//     - Evening Coverage = Ø¨Ø§Ù„Ø¶Ø¨Ø· Ø§Ù„Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø­Ø¯Ø¯ (Ù„Ø§ Ø²ÙŠØ§Ø¯Ø©ØŒ Ù„Ø§ Ù†Ù‚ØµØ§Ù†)
//  
//  ğŸ“Œ Ù†Ø¸Ø§Ù… Ø·Ø§Ø¨ÙˆØ± Ø§Ù„Ø¯ÙˆØ±Ø§Ù† (Rotation Queue):
//     - Ø·Ø§Ø¨ÙˆØ± ÙŠØ­ØªÙˆÙŠ ÙƒÙ„ Ø§Ù„Ù…ÙˆØ¸ÙØ§Øª Ø¨ØªØ±ØªÙŠØ¨ Ø¹Ø´ÙˆØ§Ø¦ÙŠ
//     - ÙƒÙ„ Ø£Ø³Ø¨ÙˆØ¹: Ø£ÙˆÙ„ X Ù„Ù„ØµØ¨Ø§Ø­ØŒ Ø¨Ø¹Ø¯Ù‡Ù… Y Ù„Ù„Ù…Ø³Ø§Ø¡
//     - Ø¨Ø¹Ø¯ ÙƒÙ„ Ø£Ø³Ø¨ÙˆØ¹: Ø§Ù„Ù…ÙˆØ¸ÙØ§Øª Ø§Ù„Ù„Ø§ØªÙŠ Ø¹Ù…Ù„Ù† ÙŠÙ†ØªÙ‚Ù„Ù† Ù„Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ø·Ø§Ø¨ÙˆØ±
//     - Ù‡Ø°Ø§ ÙŠØ¶Ù…Ù†: Ø£Ø³Ø¨ÙˆØ¹ÙŠÙ† ØµØ¨Ø§Ø­ + Ø£Ø³Ø¨ÙˆØ¹ÙŠÙ† Ù…Ø³Ø§Ø¡ Ù„ÙƒÙ„ Ù…ÙˆØ¸ÙØ©
//     - Ù„Ø§ ÙŠØªØºÙŠØ± Ø§Ù„Ø´ÙØª Ø¯Ø§Ø®Ù„ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ Ù…Ù‡Ù…Ø§ ÙƒØ§Ù†Øª Ø­Ø§Ù„Ø§Øª OFF
//  
//  ğŸ“Œ Ù‚ÙˆØ§Ø¹Ø¯ Ø§Ù„Ø¥Ø¬Ø§Ø²Ø§Øª:
//     - Ø§Ù„Ø¬Ù…Ø¹Ø©: OFF Ù„Ù„Ø¬Ù…ÙŠØ¹
//     - Ù…Ø±ÙˆØ© (Marwa Alrehaili): Ø§Ù„Ø³Ø¨Øª OFF Ø¯Ø§Ø¦Ù…Ø§Ù‹
//     - ÙƒÙ„ Ù…ÙˆØ¸ÙØ©: OFF ÙˆØ§Ø­Ø¯ ÙÙ‚Ø· Ø£Ø³Ø¨ÙˆØ¹ÙŠØ§Ù‹
//     - Ø­Ø¯ Ø£Ù‚ØµÙ‰ 2 OFF ÙÙŠ Ø§Ù„ÙŠÙˆÙ… (Ø¹Ø¯Ø§ Ø§Ù„Ø¬Ù…Ø¹Ø©)
//     - Ù„Ø§ OFF Ø¥Ø¶Ø§ÙÙŠ Ø£Ø¨Ø¯Ø§Ù‹
//     - Ø·Ù„Ø¨Ø§Øª OFF/V Ø§Ù„Ù…Ø³Ø¨Ù‚Ø© ØªÙØ­ØªØ±Ù…
//  
//  ğŸ“Œ Between Shift:
//     - Ø¥Ø°Ø§ ON: Ù„Ù„Ù…ÙˆØ¸ÙØ© Ø§Ù„Ù…Ø­Ø¯Ø¯Ø© ÙÙ‚Ø·
//     - Ø¥Ø°Ø§ OFF: Ù„Ø§ ÙŠØ³ØªØ®Ø¯Ù… Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹
//  
//  ğŸ“Œ Ø§Ù„Ø´ÙØªØ§Øª Ø§Ù„Ù…Ø³Ù…ÙˆØ­Ø© ÙÙ‚Ø·:
//     ØµØ¨Ø§Ø­: MA1, MA2, M2, PT4
//     Ù…Ø³Ø§Ø¡: EA1, E5, E2, MA4, PT5
//     Ù„ÙŠÙ„: MA3
//     Ø¥Ø¬Ø§Ø²Ø©: O, V
//  
//  ğŸ“Œ ÙˆØ¶Ø¹ Preview:
//     - preview=true: ÙŠÙˆÙ„Ù‘Ø¯ Ø¬Ø¯ÙˆÙ„ Ø¨Ø¯ÙˆÙ† Ø­ÙØ¸
//     - seed Ø¹Ø´ÙˆØ§Ø¦ÙŠ: ÙƒÙ„ Ø¶ØºØ·Ø© "ØªÙˆÙ„ÙŠØ¯" ØªØ¹Ø·ÙŠ Ù†ØªÙŠØ¬Ø© Ù…Ø®ØªÙ„ÙØ©
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

import {
  startOfMonth,
  endOfMonth,
  eachDayOfInterval,
  format,
  getDay
} from "date-fns";

import supabaseServer from "@/app/lib/supabaseServer";

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CONSTANTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const OFF = "O";
const VAC = "V";
const BETWEEN = "B";

// Ø§Ù„Ø´ÙØªØ§Øª Ø§Ù„Ù…Ø³Ù…ÙˆØ­Ø© ÙÙ‚Ø·
const MORNING_SHIFTS: Record<string, string> = {
  FullTime: "MA1",
  PartTime: "PT4",
  Trainee: "M2"
};

const EVENING_SHIFTS: Record<string, string> = {
  FullTime: "EA1",
  PartTime: "PT5",
  Trainee: "E2"
};

const MARWA_NAME = "Marwa Alrehaili"; // Ø§Ø³Ù… Ù…Ø±ÙˆØ© Ù„Ù„Ø¨Ø­Ø«
const MAX_OFF_PER_DAY = 2;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SEEDED RANDOM - Ù„ØªÙˆÙ„ÙŠØ¯ Ø¬Ø¯Ø§ÙˆÙ„ Ù…Ø®ØªÙ„ÙØ© Ù…Ø¹ ÙƒÙ„ seed
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function seededRandom(seed: number): () => number {
  return function() {
    seed = (seed * 1103515245 + 12345) & 0x7fffffff;
    return seed / 0x7fffffff;
  };
}

function shuffleWithSeed<T>(arr: T[], seed: number): T[] {
  const result = [...arr];
  const random = seededRandom(seed);
  for (let i = result.length - 1; i > 0; i--) {
    const j = Math.floor(random() * (i + 1));
    [result[i], result[j]] = [result[j], result[i]];
  }
  return result;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TYPES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
type ShiftType = "Morning" | "Evening";

interface Employee {
  id: number | string;
  name: string;
  employment_type?: string;
}

interface Settings {
  coverageMorning: number;
  coverageEvening: number;
  useBetweenShift: boolean;
  betweenShiftEmployeeId: string | null;
}

interface DayAssignment {
  month_id: string;
  employee_id: string;
  date: string;
  symbol: string;
  code: string;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// HELPER FUNCTIONS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// Ø­Ø³Ø§Ø¨ Ø±Ù‚Ù… Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ (Ø§Ù„Ø³Ø¨Øª = Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹)
function getWeekNumber(date: Date, monthStart: Date): number {
  const startDay = monthStart.getDay();
  const dayOfMonth = date.getDate();
  // Ø­Ø³Ø§Ø¨ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ø³Ø¨Øª ÙƒØ¨Ø¯Ø§ÙŠØ©
  const adjustedDay = dayOfMonth + ((startDay + 1) % 7);
  return Math.ceil(adjustedDay / 7);
}

// Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø±Ù…Ø² Ø§Ù„Ø´ÙØª Ø­Ø³Ø¨ Ù†ÙˆØ¹ Ø§Ù„Ù…ÙˆØ¸ÙØ©
function getShiftSymbol(emp: Employee, shiftType: ShiftType): string {
  const empType = emp.employment_type || "FullTime";
  if (shiftType === "Morning") {
    return MORNING_SHIFTS[empType] || MORNING_SHIFTS.FullTime;
  }
  return EVENING_SHIFTS[empType] || EVENING_SHIFTS.FullTime;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MAIN FUNCTION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
export async function generateSchedule({
  year,
  month,
  preview = false,
  seed
}: {
  year: number;
  month: number;
  preview?: boolean;  // true = Ù„Ø§ ÙŠØ­ÙØ¸ ÙÙŠ DB
  seed?: number;      // seed Ø¹Ø´ÙˆØ§Ø¦ÙŠ Ù„ØªÙˆÙ„ÙŠØ¯ Ø¬Ø¯Ø§ÙˆÙ„ Ù…Ø®ØªÙ„ÙØ©
}) {
  const sb = supabaseServer();
  
  // Ø¥Ø°Ø§ Ù„Ù… ÙŠØªÙ… ØªÙ…Ø±ÙŠØ± seedØŒ Ù†Ø³ØªØ®Ø¯Ù… ÙˆÙ‚Øª Ø¹Ø´ÙˆØ§Ø¦ÙŠ
  const actualSeed = seed ?? Date.now();
  
  console.log(`\n${'â•'.repeat(60)}`);
  console.log(`[SCHEDULER v12] Ø¥Ù†Ø´Ø§Ø¡ Ø¬Ø¯ÙˆÙ„ ${year}-${month}`);
  console.log(`[MODE] ${preview ? 'PREVIEW (Ø¨Ø¯ÙˆÙ† Ø­ÙØ¸)' : 'SAVE (Ø­ÙØ¸ ÙÙŠ DB)'}`);
  console.log(`[SEED] ${actualSeed}`);
  console.log(`${'â•'.repeat(60)}\n`);

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // Ø§Ù„Ø®Ø·ÙˆØ© 1: ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  
  // Ø¥Ù†Ø´Ø§Ø¡/ØªØ­Ø¯ÙŠØ« Ø³Ø¬Ù„ Ø§Ù„Ø´Ù‡Ø±
  const { data: monthRow, error: monthErr } = await sb
    .from("months")
    .upsert({ year, month }, { onConflict: "year,month" })
    .select("*")
    .single();
  
  if (monthErr || !monthRow) {
    throw new Error(monthErr?.message || "ÙØ´Ù„ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø³Ø¬Ù„ Ø§Ù„Ø´Ù‡Ø±");
  }

  // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…ÙˆØ¸ÙØ§Øª
  const { data: empData } = await sb.from("employees").select("*").order("name");
  const allEmployees: Employee[] = (empData || []) as Employee[];
  console.log(`[1] Ø¹Ø¯Ø¯ Ø§Ù„Ù…ÙˆØ¸ÙØ§Øª: ${allEmployees.length}`);

  // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª (Ø§Ù„Ù…ØµØ¯Ø± Ø§Ù„ÙˆØ­ÙŠØ¯ Ù„Ù„Ø­Ù‚ÙŠÙ‚Ø©)
  const { data: settingsData } = await sb.from("settings").select("key, value");
  const settingsMap: Record<string, string> = {};
  for (const s of settingsData || []) {
    if (s.key) settingsMap[s.key] = s.value ?? "";
  }
  
  const settings: Settings = {
    coverageMorning: Number(settingsMap['coverageMorning']) || 0,
    coverageEvening: Number(settingsMap['coverageEvening']) || 0,
    useBetweenShift: settingsMap['useBetweenShift'] === 'true',
    betweenShiftEmployeeId: settingsMap['betweenShiftEmployeeId'] || null
  };
  
  console.log(`[1] Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª:`);
  console.log(`    - ØªØºØ·ÙŠØ© Ø§Ù„ØµØ¨Ø§Ø­: ${settings.coverageMorning}`);
  console.log(`    - ØªØºØ·ÙŠØ© Ø§Ù„Ù…Ø³Ø§Ø¡: ${settings.coverageEvening}`);
  console.log(`    - Between Shift: ${settings.useBetweenShift ? 'ON' : 'OFF'}`);

  // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
  if (settings.coverageMorning === 0 || settings.coverageEvening === 0) {
    throw new Error("ÙŠØ¬Ø¨ ØªØ­Ø¯ÙŠØ¯ Ù‚ÙŠÙ… Ø§Ù„ØªØºØ·ÙŠØ© ÙÙŠ ØµÙØ­Ø© Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª");
  }

  // ÙØµÙ„ Ù…ÙˆØ¸ÙØ© Between Shift
  let betweenEmployee: Employee | null = null;
  let regularEmployees: Employee[] = allEmployees;
  
  if (settings.useBetweenShift && settings.betweenShiftEmployeeId) {
    betweenEmployee = allEmployees.find(e => String(e.id) === settings.betweenShiftEmployeeId) || null;
    if (betweenEmployee) {
      regularEmployees = allEmployees.filter(e => String(e.id) !== settings.betweenShiftEmployeeId);
      console.log(`    - Ù…ÙˆØ¸ÙØ© Between: ${betweenEmployee.name}`);
    }
  }

  // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥Ø¬Ø§Ø²Ø§Øª ÙˆØ§Ù„Ø·Ù„Ø¨Ø§Øª
  const { data: vacationData } = await sb.from("requests").select("*").eq("type", "Vacation");
  const { data: offRequestData } = await sb.from("requests").select("*").eq("type", "OffRequest");
  
  const vacationSet = new Set<string>();
  for (const v of vacationData || []) {
    vacationSet.add(`${v.employee_id}_${format(new Date(v.date), "yyyy-MM-dd")}`);
  }
  
  const offRequestSet = new Set<string>();
  for (const o of offRequestData || []) {
    offRequestSet.add(`${o.employee_id}_${format(new Date(o.date), "yyyy-MM-dd")}`);
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // Ø§Ù„Ø®Ø·ÙˆØ© 2: ØªØ­Ø¶ÙŠØ± Ø§Ù„Ø£ÙŠØ§Ù… ÙˆØ§Ù„Ø£Ø³Ø§Ø¨ÙŠØ¹
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  
  const monthStart = startOfMonth(new Date(year, month - 1, 1));
  const monthEnd = endOfMonth(monthStart);
  const allDays = eachDayOfInterval({ start: monthStart, end: monthEnd });
  
  // ØªØ¬Ù…ÙŠØ¹ Ø§Ù„Ø£ÙŠØ§Ù… Ø­Ø³Ø¨ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹
  const weekDaysMap = new Map<number, Date[]>();
  for (const day of allDays) {
    const weekNum = getWeekNumber(day, monthStart);
    if (!weekDaysMap.has(weekNum)) weekDaysMap.set(weekNum, []);
    weekDaysMap.get(weekNum)!.push(day);
  }
  
  const weeks = [...weekDaysMap.keys()].sort((a, b) => a - b);
  console.log(`[2] Ø¹Ø¯Ø¯ Ø§Ù„Ø£ÙŠØ§Ù…: ${allDays.length}, Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø§Ø¨ÙŠØ¹: ${weeks.length}`);

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // Ø§Ù„Ø®Ø·ÙˆØ© 3: ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø´ÙØªØ§Øª Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ÙŠØ© (ØªÙ†Ø§ÙˆØ¨ 2+2)
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  
  console.log(`\n[3] ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø´ÙØªØ§Øª Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ÙŠØ©...`);
  
  // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ù…Ø±ÙˆØ© Ø¨Ø§Ù„Ø§Ø³Ù…
  const marwaEmployee = allEmployees.find(e => 
    e.name.toLowerCase().includes('marwa') || 
    e.name.includes('Ù…Ø±ÙˆØ©')
  );
  const marwaId = marwaEmployee ? String(marwaEmployee.id) : null;
  if (marwaEmployee) {
    console.log(`    - Ù…Ø±ÙˆØ©: ${marwaEmployee.name} (ID: ${marwaId})`);
  }
  
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // Ù†Ø¸Ø§Ù… Ø·Ø§Ø¨ÙˆØ± Ø§Ù„Ø¯ÙˆØ±Ø§Ù† (Rotation Queue)
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // - Ø·Ø§Ø¨ÙˆØ± ÙŠØ­ØªÙˆÙŠ ÙƒÙ„ Ø§Ù„Ù…ÙˆØ¸ÙØ§Øª Ø¨ØªØ±ØªÙŠØ¨ Ø¹Ø´ÙˆØ§Ø¦ÙŠ
  // - ÙƒÙ„ Ø£Ø³Ø¨ÙˆØ¹: Ø£ÙˆÙ„ X Ù„Ù„ØµØ¨Ø§Ø­ØŒ Ø¨Ø¹Ø¯Ù‡Ù… Y Ù„Ù„Ù…Ø³Ø§Ø¡
  // - Ø¨Ø¹Ø¯ ÙƒÙ„ Ø£Ø³Ø¨ÙˆØ¹: Ø§Ù„Ù…ÙˆØ¸ÙØ§Øª Ø§Ù„Ù„Ø§ØªÙŠ Ø¹Ù…Ù„Ù† ÙŠÙ†ØªÙ‚Ù„Ù† Ù„Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ø·Ø§Ø¨ÙˆØ±
  // - Ù‡Ø°Ø§ ÙŠØ¶Ù…Ù†: Ø£Ø³Ø¨ÙˆØ¹ÙŠÙ† ØµØ¨Ø§Ø­ + Ø£Ø³Ø¨ÙˆØ¹ÙŠÙ† Ù…Ø³Ø§Ø¡ Ù„ÙƒÙ„ Ù…ÙˆØ¸ÙØ©
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  
  // Ø®Ù„Ø· Ø§Ù„Ù…ÙˆØ¸ÙØ§Øª Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… seed Ù„ØªÙˆÙ„ÙŠØ¯ ØªÙˆØ²ÙŠØ¹Ø§Øª Ù…Ø®ØªÙ„ÙØ©
  let rotationQueue = shuffleWithSeed(regularEmployees, actualSeed);
  
  console.log(`    - Ø¹Ø¯Ø¯ Ø§Ù„Ù…ÙˆØ¸ÙØ§Øª ÙÙŠ Ø§Ù„Ø·Ø§Ø¨ÙˆØ±: ${rotationQueue.length}`);
  console.log(`    - Ø§Ù„ØªØºØ·ÙŠØ© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©: ØµØ¨Ø§Ø­=${settings.coverageMorning}, Ù…Ø³Ø§Ø¡=${settings.coverageEvening}`);
  
  // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø£Ù† Ø¹Ø¯Ø¯ Ø§Ù„Ù…ÙˆØ¸ÙØ§Øª ÙƒØ§ÙÙ
  const totalNeeded = settings.coverageMorning + settings.coverageEvening;
  if (rotationQueue.length < totalNeeded) {
    console.warn(`    âš ï¸ ØªØ­Ø°ÙŠØ±: Ø¹Ø¯Ø¯ Ø§Ù„Ù…ÙˆØ¸ÙØ§Øª (${rotationQueue.length}) Ø£Ù‚Ù„ Ù…Ù† Ø§Ù„Ù…Ø·Ù„ÙˆØ¨ (${totalNeeded})`);
  }
  
  // Ø¨Ù†Ø§Ø¡ Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø´ÙØªØ§Øª Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ÙŠØ©
  // weekNum -> empId -> ShiftType
  const weeklyShifts = new Map<number, Map<string, ShiftType>>();
  
  // ØªØªØ¨Ø¹ Ø¹Ø¯Ø¯ Ø£Ø³Ø§Ø¨ÙŠØ¹ Ø§Ù„ØµØ¨Ø§Ø­ ÙˆØ§Ù„Ù…Ø³Ø§Ø¡ Ù„ÙƒÙ„ Ù…ÙˆØ¸ÙØ© (Ù„Ù„ØªØ­Ù‚Ù‚)
  const empShiftCount = new Map<string, { morning: number; evening: number }>();
  for (const emp of regularEmployees) {
    empShiftCount.set(String(emp.id), { morning: 0, evening: 0 });
  }
  
  for (const weekNum of weeks) {
    const shiftMap = new Map<string, ShiftType>();
    weeklyShifts.set(weekNum, shiftMap);
    
    // Ø§Ø®ØªÙŠØ§Ø± Ù…ÙˆØ¸ÙØ§Øª Ø§Ù„ØµØ¨Ø§Ø­ (Ø£ÙˆÙ„ X Ù…Ù† Ø§Ù„Ø·Ø§Ø¨ÙˆØ±)
    const morningThisWeek = rotationQueue.slice(0, settings.coverageMorning);
    
    // Ø§Ø®ØªÙŠØ§Ø± Ù…ÙˆØ¸ÙØ§Øª Ø§Ù„Ù…Ø³Ø§Ø¡ (Ø¨Ø¹Ø¯ Ø§Ù„ØµØ¨Ø§Ø­ Ù…Ø¨Ø§Ø´Ø±Ø©)
    const eveningThisWeek = rotationQueue.slice(
      settings.coverageMorning, 
      settings.coverageMorning + settings.coverageEvening
    );
    
    // ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø´ÙØªØ§Øª
    for (const emp of morningThisWeek) {
      const empId = String(emp.id);
      shiftMap.set(empId, "Morning");
      const count = empShiftCount.get(empId)!;
      count.morning++;
    }
    
    for (const emp of eveningThisWeek) {
      const empId = String(emp.id);
      shiftMap.set(empId, "Evening");
      const count = empShiftCount.get(empId)!;
      count.evening++;
    }
    
    // Ø§Ù„Ù…ÙˆØ¸ÙØ§Øª Ø§Ù„Ø²Ø§Ø¦Ø¯Ø§Øª (Ø¥Ù† ÙˆØ¬Ø¯Ù†) Ù„Ø§ ÙŠÙØ¹Ø·ÙŠÙ† Ø´ÙØª Ù‡Ø°Ø§ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹
    const workingThisWeek = [...morningThisWeek, ...eveningThisWeek];
    const notWorkingThisWeek = rotationQueue.slice(totalNeeded);
    
    console.log(`    - Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ ${weekNum}: ØµØ¨Ø§Ø­=${morningThisWeek.length}, Ù…Ø³Ø§Ø¡=${eveningThisWeek.length}, Ø¨Ø¯ÙˆÙ† Ø´ÙØª=${notWorkingThisWeek.length}`);
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // ØªØ¯ÙˆÙŠØ± Ø§Ù„Ø·Ø§Ø¨ÙˆØ±: Ø§Ù„Ù…ÙˆØ¸ÙØ§Øª Ø§Ù„Ù„Ø§ØªÙŠ Ø¹Ù…Ù„Ù† ÙŠÙ†ØªÙ‚Ù„Ù† Ù„Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ø·Ø§Ø¨ÙˆØ±
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    rotationQueue = [...notWorkingThisWeek, ...workingThisWeek];
  }
  
  // Ø·Ø¨Ø§Ø¹Ø© Ù…Ù„Ø®Øµ Ø§Ù„ØªÙˆØ²ÙŠØ¹ Ù„ÙƒÙ„ Ù…ÙˆØ¸ÙØ©
  console.log(`\n    ğŸ“Š Ù…Ù„Ø®Øµ Ø§Ù„ØªÙˆØ²ÙŠØ¹:`);
  for (const emp of regularEmployees) {
    const empId = String(emp.id);
    const count = empShiftCount.get(empId)!;
    console.log(`    - ${emp.name}: ØµØ¨Ø§Ø­=${count.morning} Ø£Ø³Ø§Ø¨ÙŠØ¹, Ù…Ø³Ø§Ø¡=${count.evening} Ø£Ø³Ø§Ø¨ÙŠØ¹`);
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // Ø§Ù„Ø®Ø·ÙˆØ© 4: ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø¥Ø¬Ø§Ø²Ø§Øª Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ÙŠØ©
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  
  console.log(`\n[4] ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø¥Ø¬Ø§Ø²Ø§Øª Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ÙŠØ©...`);
  
  // weekNum -> empId -> dateISO
  const weeklyOffDays = new Map<number, Map<string, string>>();
  
  for (const weekNum of weeks) {
    const offMap = new Map<string, string>();
    weeklyOffDays.set(weekNum, offMap);
    
    const weekDays = weekDaysMap.get(weekNum) || [];
    // Ø£ÙŠØ§Ù… Ø§Ù„Ø¹Ù…Ù„ (Ø¨Ø¯ÙˆÙ† Ø§Ù„Ø¬Ù…Ø¹Ø©)
    const workDays = weekDays.filter(d => getDay(d) !== 5);
    
    if (workDays.length === 0) continue;
    
    // ØªØªØ¨Ø¹ Ø¹Ø¯Ø¯ OFF Ù„ÙƒÙ„ ÙŠÙˆÙ…
    const dayOffCount = new Map<string, number>();
    for (const d of workDays) {
      dayOffCount.set(format(d, "yyyy-MM-dd"), 0);
    }
    
    // Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…ÙˆØ¸ÙØ§Øª (Ø¹Ø§Ø¯ÙŠØ© + between)
    const allEmpsForOff = [...regularEmployees];
    if (betweenEmployee) allEmpsForOff.push(betweenEmployee);
    
    for (const emp of allEmpsForOff) {
      const empId = String(emp.id);
      
      // 1. Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø·Ù„Ø¨ OFF Ù…Ø³Ø¨Ù‚
      for (const d of workDays) {
        const dateISO = format(d, "yyyy-MM-dd");
        if (offRequestSet.has(`${empId}_${dateISO}`)) {
          const count = dayOffCount.get(dateISO) || 0;
          if (count < MAX_OFF_PER_DAY) {
            offMap.set(empId, dateISO);
            dayOffCount.set(dateISO, count + 1);
            break;
          }
        }
      }
      if (offMap.has(empId)) continue;
      
      // 2. Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø¥Ø¬Ø§Ø²Ø© V - Ù„Ø§ ØªØ¹Ø·Ù‰ OFF Ø¥Ø¶Ø§ÙÙŠ
      let hasVacation = false;
      for (const d of workDays) {
        const dateISO = format(d, "yyyy-MM-dd");
        if (vacationSet.has(`${empId}_${dateISO}`)) {
          hasVacation = true;
          break;
        }
      }
      if (hasVacation) continue;
      
      // 3. Ù…Ø±ÙˆØ©: Ø§Ù„Ø³Ø¨Øª OFF Ø¯Ø§Ø¦Ù…Ø§Ù‹
      if (marwaId && empId === marwaId) {
        const saturday = workDays.find(d => getDay(d) === 6);
        if (saturday) {
          const dateISO = format(saturday, "yyyy-MM-dd");
          const count = dayOffCount.get(dateISO) || 0;
          if (count < MAX_OFF_PER_DAY) {
            offMap.set(empId, dateISO);
            dayOffCount.set(dateISO, count + 1);
            continue;
          }
        }
      }
      
      // 4. Ø§Ø®ØªÙŠØ§Ø± ÙŠÙˆÙ… OFF Ø¨Ø£Ù‚Ù„ Ø¹Ø¯Ø¯ Ø¥Ø¬Ø§Ø²Ø§Øª
      let bestDay: string | null = null;
      let minCount = Infinity;
      
      for (const d of workDays) {
        const dateISO = format(d, "yyyy-MM-dd");
        const count = dayOffCount.get(dateISO) || 0;
        if (count < MAX_OFF_PER_DAY && count < minCount) {
          minCount = count;
          bestDay = dateISO;
        }
      }
      
      if (bestDay) {
        offMap.set(empId, bestDay);
        dayOffCount.set(bestDay, (dayOffCount.get(bestDay) || 0) + 1);
      }
    }
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // Ø§Ù„Ø®Ø·ÙˆØ© 5: Ø¨Ù†Ø§Ø¡ Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„ÙŠÙˆÙ…ÙŠ
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  
  console.log(`\n[5] Ø¨Ù†Ø§Ø¡ Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„ÙŠÙˆÙ…ÙŠ...`);
  
  const rows: DayAssignment[] = [];
  
  for (const day of allDays) {
    const dateISO = format(day, "yyyy-MM-dd");
    const dow = getDay(day);
    const weekNum = getWeekNumber(day, monthStart);
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // Ø§Ù„Ø¬Ù…Ø¹Ø©: OFF Ù„Ù„Ø¬Ù…ÙŠØ¹
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    if (dow === 5) {
      for (const emp of allEmployees) {
        rows.push({
          month_id: monthRow.id,
          employee_id: String(emp.id),
          date: dateISO,
          symbol: OFF,
          code: OFF
        });
      }
      continue;
    }
    
    const weekOffMap = weeklyOffDays.get(weekNum) || new Map();
    const weekShiftMap = weeklyShifts.get(weekNum) || new Map();
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆØ¸ÙØ§Øª Ø§Ù„Ù…ØªØ§Ø­Ø§Øª Ù„ÙƒÙ„ Ø´ÙØª
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    const availableMorning: Employee[] = [];
    const availableEvening: Employee[] = [];
    
    for (const emp of regularEmployees) {
      const empId = String(emp.id);
      
      // ØªØ®Ø·ÙŠ Ø¥Ø°Ø§ Ø¥Ø¬Ø§Ø²Ø© Ø£Ùˆ OFF
      if (vacationSet.has(`${empId}_${dateISO}`)) continue;
      if (weekOffMap.get(empId) === dateISO) continue;
      
      const shift = weekShiftMap.get(empId);
      if (shift === "Morning") {
        availableMorning.push(emp);
      } else if (shift === "Evening") {
        availableEvening.push(emp);
      }
    }
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // Ø§Ø®ØªÙŠØ§Ø± Ø¨Ø§Ù„Ø¶Ø¨Ø· Ø§Ù„Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    const selectedMorning = availableMorning.slice(0, settings.coverageMorning);
    const selectedEvening = availableEvening.slice(0, settings.coverageEvening);
    
    const selectedMorningIds = new Set(selectedMorning.map(e => String(e.id)));
    const selectedEveningIds = new Set(selectedEvening.map(e => String(e.id)));
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // Ø¨Ù†Ø§Ø¡ Ø§Ù„Ø³Ø¬Ù„Ø§Øª
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    for (const emp of allEmployees) {
      const empId = String(emp.id);
      let symbol: string;
      
      // 1. Ø¥Ø¬Ø§Ø²Ø© V
      if (vacationSet.has(`${empId}_${dateISO}`)) {
        symbol = VAC;
      }
      // 2. OFF Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ÙŠ
      else if (weekOffMap.get(empId) === dateISO) {
        symbol = OFF;
      }
      // 3. Ù…ÙˆØ¸ÙØ© Between Shift
      else if (betweenEmployee && empId === String(betweenEmployee.id)) {
        symbol = BETWEEN;
      }
      // 4. Ø´ÙØª ØµØ¨Ø§Ø­
      else if (selectedMorningIds.has(empId)) {
        symbol = getShiftSymbol(emp, "Morning");
      }
      // 5. Ø´ÙØª Ù…Ø³Ø§Ø¡
      else if (selectedEveningIds.has(empId)) {
        symbol = getShiftSymbol(emp, "Evening");
      }
      // 6. Ù…ÙˆØ¸ÙØ© ØºÙŠØ± Ù…Ø®ØªØ§Ø±Ø© Ù„Ù„ØªØºØ·ÙŠØ© (Ù„Ø§ ØªØ¹Ù…Ù„ Ù‡Ø°Ø§ Ø§Ù„ÙŠÙˆÙ…)
      else {
        // Ù‡Ø°Ù‡ Ø§Ù„Ù…ÙˆØ¸ÙØ© Ù„ÙŠØ³Øª Ø¶Ù…Ù† Ø§Ù„ØªØºØ·ÙŠØ© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©
        // Ù„ÙƒÙ† Ù„Ø§ Ù†Ø¹Ø·ÙŠÙ‡Ø§ OFF Ø¥Ø¶Ø§ÙÙŠ - ØªØ¨Ù‚Ù‰ Ø¨Ø¯ÙˆÙ† Ø´ÙØª
        const shift = weekShiftMap.get(empId);
        if (shift) {
          symbol = getShiftSymbol(emp, shift);
        } else {
          symbol = OFF;
        }
      }
      
      rows.push({
        month_id: monthRow.id,
        employee_id: String(emp.id),
        date: dateISO,
        symbol,
        code: symbol
      });
    }
  }
  
  console.log(`[5] Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø³Ø¬Ù„Ø§Øª: ${rows.length}`);

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // Ø§Ù„Ø®Ø·ÙˆØ© 6: Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØªØºØ·ÙŠØ©
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  
  console.log(`\n[6] Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØªØºØ·ÙŠØ©...`);
  
  const morningSymbols = Object.values(MORNING_SHIFTS);
  const eveningSymbols = Object.values(EVENING_SHIFTS);
  
  let issues = 0;
  
  for (const day of allDays) {
    const dateISO = format(day, "yyyy-MM-dd");
    if (getDay(day) === 5) continue;
    
    const dayRows = rows.filter(r => r.date === dateISO);
    const mCount = dayRows.filter(r => morningSymbols.includes(r.symbol)).length;
    const eCount = dayRows.filter(r => eveningSymbols.includes(r.symbol)).length;
    
    if (mCount !== settings.coverageMorning) {
      console.log(`    âš ï¸ ${dateISO}: ØµØ¨Ø§Ø­=${mCount}/${settings.coverageMorning}`);
      issues++;
    }
    if (eCount !== settings.coverageEvening) {
      console.log(`    âš ï¸ ${dateISO}: Ù…Ø³Ø§Ø¡=${eCount}/${settings.coverageEvening}`);
      issues++;
    }
  }
  
  if (issues === 0) {
    console.log(`    âœ… Ø§Ù„ØªØºØ·ÙŠØ© Ù…Ø·Ø§Ø¨Ù‚Ø© Ù„Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª!`);
  } else {
    console.log(`    âš ï¸ ${issues} Ù…Ø´ÙƒÙ„Ø© ÙÙŠ Ø§Ù„ØªØºØ·ÙŠØ©`);
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // Ø§Ù„Ø®Ø·ÙˆØ© 7: Ø§Ù„Ø­ÙØ¸ ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (ÙÙ‚Ø· Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† preview)
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  
  if (!preview) {
    console.log(`\n[7] Ø§Ù„Ø­ÙØ¸ ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...`);
    
    await sb.from("assignments").delete().eq("month_id", monthRow.id);
    const { error: insertErr } = await sb.from("assignments").insert(rows);
    
    if (insertErr) throw insertErr;
    console.log(`    âœ… ØªÙ… Ø­ÙØ¸ ${rows.length} Ø³Ø¬Ù„!`);
  } else {
    console.log(`\n[7] ÙˆØ¶Ø¹ Preview - Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø­ÙØ¸ ÙÙŠ DB`);
  }

  // ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„ØµÙŠØºØ© Ù…Ù†Ø§Ø³Ø¨Ø© Ù„Ù„Ø¹Ø±Ø¶
  const assignmentsForDisplay = rows.map(r => ({
    employee_id: r.employee_id,
    date: r.date,
    symbol: r.symbol
  }));

  return {
    ok: true,
    preview,
    seed: actualSeed,
    month: {
      id: monthRow.id,
      year,
      month
    },
    employees: allEmployees.map(e => ({
      id: String(e.id),
      name: e.name,
      code: (e as any).code || null
    })),
    assignments: assignmentsForDisplay,
    debug: {
      totalEmployees: allEmployees.length,
      coverageMorning: settings.coverageMorning,
      coverageEvening: settings.coverageEvening,
      useBetweenShift: settings.useBetweenShift,
      betweenEmployee: betweenEmployee?.name || null,
      weeks: weeks.length,
      totalAssignments: rows.length,
      issues
    }
  };
}
